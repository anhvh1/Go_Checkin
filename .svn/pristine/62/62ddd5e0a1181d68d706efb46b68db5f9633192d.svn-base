import React, {Component} from 'react';
import Constants, {ITEM_LAYOUT3, REQUIRED} from '../../../settings/constants';
import {Modal, Form, Input, Button, message} from 'antd';
import Select, {Option} from '../../../components/uielements/select';
import api from "./config";
import Styled from './styled';

const {Item} = Form;

const ModalAddEdit = Form.create({name: 'modal'})(
  class extends Component {
    constructor(props) {
      super(props);
      this.state = {
        DanhSachTinh: [],
        DanhSachHuyen: [],
        DanhSachXa: [],
        CoQuanChaID: "",
        TenCoQuanCha: "",
        allRight: false,
        disabled: true,

        TinhID: undefined,
        HuyenID: undefined,
        XaID: undefined,
        listCap: [],
        CoQuanID: null
      };
    }

    async componentDidMount() {
      const {dataModal} = this.props;
      if (dataModal) {
        const {DanhSachTinh, Data} = dataModal;
        const {CoQuanChaID, TenCoQuanCha, CoQuanID} = Data;
        let listCap = [
          {value: "1", label: "Cấp UBND tỉnh"}
        ];
        this.setState({DanhSachTinh});
        if (CoQuanID) {
          const {TinhID, HuyenID, XaID} = Data;
          this.onChangeTinh(TinhID, false);
          this.onChangeHuyen(HuyenID, false);
          this.setState({TinhID, HuyenID, XaID, CoQuanID, allRight: true}, () => {
            this.props.form.setFieldsValue({TenCoQuan: Data.TenCoQuan, TinhID, XaID, HuyenID});
          });
          if (CoQuanChaID) {
            this.setState({TenCoQuanCha, CoQuanChaID});
          }
        } else {
          if (CoQuanChaID) {
            const response = await api.chiTietCoQuan({CoQuanID: CoQuanChaID});
            if (response.data.Status > 0) {
              const TinhID = response.data.Data.TinhID;
              const HuyenID = response.data.Data.HuyenID;
              if (TinhID && HuyenID) {
                if (response.data.Data.CapID === 1) {
                  listCap = [
                    {value: "2", label: "Cấp sở, ban ngành"},
                    {value: "3", label: "Cấp UBND huyện"}
                  ];
                } else if (response.data.Data.CapID > 1) {
                  listCap = [
                    {value: "4", label: "Cấp phòng ban"},
                    {value: "5", label: "Cấp UBND xã"}
                  ];
                }
                const diagioihuyen = await api.danhSachDiaGioi({ID: TinhID, Cap: Constants.HUYEN});
                if (diagioihuyen.data.Status > 0) {
                  const diagioixa = await api.danhSachDiaGioi({ID: HuyenID, Cap: Constants.XA});
                  if (diagioixa.data.Status > 0) {
                    this.setState({
                      TinhID,
                      HuyenID,
                      listCap,
                      DanhSachHuyen: diagioihuyen.data.Data,
                      DanhSachXa: diagioixa.data.Data,
                      CoQuanChaID,
                      TenCoQuanCha,
                      allRight: true,
                    });
                  }
                }
              }
            }
          } else {
            this.setState({
              listCap,
              CoQuanChaID,
              TenCoQuanCha,
              allRight: true
            });
          }
        }
      }
    }

    onOk = (e) => {
      e.preventDefault();
      this.props.form.validateFields((err, value) => {
        if (!err) {
          const {onCreate} = this.props;
          const {CoQuanID} = this.state;
          if (CoQuanID) {
            value.CoQuanID = CoQuanID;
          }
          onCreate({...value});
        }
      });
    };

    onChangeTinh = (TinhID, reset = true) => {
      if (TinhID) {
        api.danhSachDiaGioi({ID: TinhID, Cap: Constants.HUYEN,}).then(response => {
          if (response.data.Status > 0) {
            this.setState({DanhSachHuyen: response.data.Data,}, () => {
              reset && this.props.form.setFieldsValue({HuyenID: undefined, XaID: undefined});
            });
          } else {
            message.destroy();
            message.error(response.data.Message);
          }
        }).catch(error => {
          message.destroy();
          message.error(error.toString());
        });
      } else {
        this.setState({DanhSachHuyen: [], DanhSachXa: []}, () => {
          reset && this.props.form.setFieldsValue({HuyenID: undefined, XaID: undefined});
        });
      }
    };

    onChangeHuyen = (HuyenID, reset) => {
      if (HuyenID) {
        api.danhSachDiaGioi({ID: HuyenID, Cap: Constants.XA,}).then(response => {
          if (response.data.Status > 0) {
            this.setState({DanhSachXa: response.data.Data}, () => {
              reset && this.props.form.setFieldsValue({XaID: undefined});
            });
          } else {
            message.destroy();
            message.error(response.data.Message);
          }
        }).catch(error => {
          message.destroy();
          message.error(error.toString());
        });
      } else {
        this.setState({DanhSachXa: []}, () => {
          reset && this.props.form.setFieldsValue({XaID: undefined});
        });
      }
    };

    render() {
      const {loading, visible, onCancel, form} = this.props;
      const {getFieldDecorator} = form;
      const {CoQuanID, CoQuanChaID, TenCoQuanCha, TinhID, HuyenID, XaID, DanhSachXa} = this.state;
      if (!this.state.allRight) return null;
      return (
        <Modal
          title={`${CoQuanID ? 'Sửa' : "Thêm"} thông tin cơ quan`}
          width={550}
          visible={visible}
          onCancel={onCancel}
          footer={[
            <Button key="back" onClick={onCancel}>Hủy</Button>,
            <Button key="submit" htmlType="submit" type="primary" form="myForm"
                    loading={loading} onClick={this.onOk}>Lưu</Button>,
          ]}
        >
          <Styled>
            <Form id="myForm" layout="horizontal">
              <Item label="Tên cơ quan" {...ITEM_LAYOUT3}>
                {getFieldDecorator('TenCoQuan', {
                  rules: [{...REQUIRED}],
                })(<Input autoFocus/>)}
              </Item>
              {CoQuanChaID ? (
                <Item label="Cơ quan cha" {...ITEM_LAYOUT3}>
                  {getFieldDecorator('CoQuanChaID', {rules: [{...REQUIRED}], initialValue: CoQuanChaID})(
                    <Select disabled={this.state.disabled}>
                      <Option value={CoQuanChaID}>
                        {TenCoQuanCha}
                      </Option>
                    </Select>
                  )}
                </Item>
              ) : ""}
              <Item label="Tỉnh" {...ITEM_LAYOUT3}>
                {getFieldDecorator('TinhID', {
                  rules: [{...REQUIRED}],
                  initialValue: TinhID
                })(
                  <Select showSearch onChange={this.onChangeTinh} placeholder="Chọn địa chỉ tỉnh">
                    {this.state.DanhSachTinh.map((value) => (
                      <Option key={value.ID} value={value.ID}>
                        {value.Ten}
                      </Option>
                    ))}
                  </Select>,
                )}
              </Item>
              <Item label="Huyện" {...ITEM_LAYOUT3}>
                {getFieldDecorator('HuyenID', {
                  rules: [{...REQUIRED}],
                  initialValue: HuyenID
                })(
                  <Select showSearch onChange={this.onChangeHuyen} placeholder={"Chọn địa chỉ huyện"}>
                    {this.state.DanhSachHuyen.map((value) => (
                      <Option key={value.ID} value={value.ID}>
                        {value.Ten}
                      </Option>
                    ))}
                  </Select>,
                )}
              </Item>
              <Item label="Xã" {...ITEM_LAYOUT3}>
                {getFieldDecorator('XaID', {initialValue: XaID})(
                  <Select showSearch placeholder={"Chọn địa chỉ xã"}>
                    {this.state.DanhSachXa.map((value) => (
                      <Option key={value.ID} value={value.ID}>
                        {value.Ten}
                      </Option>
                    ))}
                  </Select>,
                )}
              </Item>
              <Item label="Địa chỉ" {...ITEM_LAYOUT3}>
                {getFieldDecorator('DiaChi')(<Input.TextArea rows={2}/>)}
              </Item>
            </Form>
          </Styled>
        </Modal>
      );
    }
  },
);
export default ModalAddEdit;